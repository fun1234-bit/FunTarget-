name: Build Cordova APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install Cordova
      run: npm install -g cordova

    # à¤ªà¥à¤°à¥‹à¤œà¥‡à¤•à¥à¤Ÿ à¤•à¥‹ à¤…à¤¨à¥›à¤¿à¤ª à¤•à¤°à¤¨à¤¾
    - name: Unzip project (safe)
      run: |
        rm -rf cordova_project
        mkdir cordova_project
        unzip -oq FunTarget_Final_Clean.zip -d cordova_project || true

    # à¤•à¥‹à¤°à¥à¤¡à¥‹à¤µà¤¾ à¤«à¥‹à¤²à¥à¤¡à¤° à¤¤à¥ˆà¤¯à¤¾à¤° à¤•à¤°à¤¨à¤¾
    - name: Prepare Cordova project
      run: |
        cd cordova_project
        PROJECT_DIR=$(find . -maxdepth 2 -name config.xml | head -n 1 | xargs dirname)
        mv "$PROJECT_DIR" project

    - name: Install project dependencies
      run: |
        cd cordova_project/project
        npm install

    - name: Add Android platform
      run: |
        cd cordova_project/project
        if [ ! -d "platforms/android" ]; then
          cordova platform add android
        else
          echo "Android platform already exists."
        fi

    # ðŸ›¡ï¸ à¤à¤‚à¤Ÿà¥€-à¤Ÿà¥ˆà¤®à¥à¤ªà¤° à¤¸à¥à¤°à¤•à¥à¤·à¤¾: à¤¯à¤¹ à¤•à¥‹à¤¡ à¤à¤ª à¤•à¥‹ à¤¦à¥‹à¤¬à¤¾à¤°à¤¾ à¤¸à¤¾à¤‡à¤¨ à¤•à¤°à¤¨à¥‡ à¤ªà¤° à¤•à¥à¤°à¥ˆà¤¶ à¤•à¤° à¤¦à¥‡à¤—à¤¾
    - name: Inject Anti-Tamper Security
      run: |
        cd cordova_project/project
        
        # à¤ªà¥ˆà¤•à¥‡à¤œ à¤†à¤ˆà¤¡à¥€ à¤†à¤ªà¤•à¥‡ config.xml à¤¸à¥‡ à¤®à¤¿à¤²à¥€ à¤¹à¥ˆ: com.funtarget.app
        # à¤«à¤¾à¤‡à¤² à¤•à¤¾ à¤¸à¤¹à¥€ à¤°à¤¾à¤¸à¥à¤¤à¤¾ à¤¢à¥‚à¤à¤¢à¤¨à¤¾
        FILE_PATH="platforms/android/app/src/main/java/com/funtarget/app/MainActivity.java"
        
        # à¤ªà¤•à¥à¤•à¤¾ à¤•à¤°à¤¨à¤¾ à¤•à¤¿ à¤«à¥‹à¤²à¥à¤¡à¤° à¤®à¥Œà¤œà¥‚à¤¦ à¤¹à¥ˆ (à¤…à¤—à¤° à¤•à¥‹à¤°à¥à¤¡à¥‹à¤µà¤¾ à¤¨à¥‡ à¤¨à¤¹à¥€à¤‚ à¤¬à¤¨à¤¾à¤¯à¤¾ à¤¤à¥‹ à¤¬à¤¨à¤¾ à¤¦à¥‡)
        mkdir -p platforms/android/app/src/main/java/com/funtarget/app/

        echo "Injecting security into $FILE_PATH"

        cat > "$FILE_PATH" <<EOF
        package com.funtarget.app;

        import android.os.Bundle;
        import android.content.pm.PackageInfo;
        import android.content.pm.PackageManager;
        import android.content.pm.Signature;
        import java.security.MessageDigest;
        import org.apache.cordova.*;

        public class MainActivity extends CordovaActivity {
            
            // âš ï¸ à¤†à¤ªà¤•à¤¾ à¤…à¤¸à¤²à¥€ SHA-256 (à¤¬à¤¿à¤¨à¤¾ à¤•à¥‹à¤²à¤¨ à¤•à¥‡) à¤¯à¤¹à¤¾à¤ à¤†à¤à¤—à¤¾
            private static final String VALID_SIG = "${{ secrets.MY_SHA256 }}";

            @Override
            public void onCreate(Bundle savedInstanceState) {
                super.onCreate(savedInstanceState);
                
                if (!checkSignature()) {
                    // à¤…à¤—à¤° à¤•à¥‹à¤ˆ à¤à¤ª à¤•à¥‡ à¤¸à¤¾à¤¥ à¤›à¥‡à¤¡à¤¼à¤–à¤¾à¤¨à¥€ à¤•à¤°à¥‡ à¤¤à¥‹ à¤à¤ª à¤¬à¤‚à¤¦ à¤¹à¥‹ à¤œà¤¾à¤
                    android.util.Log.e("SECURITY", "Tampering detected!");
                    finish();
                    System.exit(0);
                    return;
                }

                loadUrl(launchUrl);
            }

            private boolean checkSignature() {
                try {
                    PackageInfo packageInfo = getPackageManager().getPackageInfo(getPackageName(), PackageManager.GET_SIGNATURES);
                    for (Signature signature : packageInfo.signatures) {
                        MessageDigest md = MessageDigest.getInstance("SHA-256");
                        md.update(signature.toByteArray());
                        byte[] digest = md.digest();
                        StringBuilder hexString = new StringBuilder();
                        for (byte b : digest) {
                            String hex = Integer.toHexString(0xff & b);
                            if (hex.length() == 1) hexString.append('0');
                            hexString.append(hex);
                        }
                        String currentSig = hexString.toString().toUpperCase();
                        // à¤…à¤—à¤° à¤¸à¥€à¤•à¥à¤°à¥‡à¤Ÿ à¤¸à¥‡à¤Ÿ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆ à¤¤à¥‹ à¤šà¥‡à¤• à¤¸à¥à¤•à¤¿à¤ª à¤¨ à¤¹à¥‹, à¤‡à¤¸à¤²à¤¿à¤ à¤¤à¥à¤²à¤¨à¤¾ à¤•à¤°à¥‡à¤‚
                        if (currentSig.equals(VALID_SIG.toUpperCase().replace(":", ""))) {
                            return true;
                        }
                    }
                } catch (Exception e) {
                    return false;
                }
                return false;
            }
        }
        EOF

    - name: Decode Keystore
      run: |
        cd cordova_project/project
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > my-release-key.jks

    - name: Create build.json for Signing
      run: |
        cd cordova_project/project
        echo '{
          "android": {
            "release": {
              "keystore": "my-release-key.jks",
              "storePassword": "${{ secrets.KEYSTORE_PASSWORD }}",
              "alias": "my-key-alias",
              "password": "${{ secrets.KEYSTORE_PASSWORD }}",
              "keystoreType": ""
            }
          }
        }' > build.json

    - name: Build APK (Fully Signed)
      run: |
        cd cordova_project/project
        cordova build android --release --buildConfig=build.json --verbose

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FunTarget-Pro-Signed
        path: |
          cordova_project/project/platforms/android/app/build/outputs/apk/release/*.apk
          cordova_project/project/platforms/android/app/build/outputs/bundle/release/*.aab
