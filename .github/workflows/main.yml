name: Build Cordova APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install Cordova
      run: npm install -g cordova

    # ðŸ”¥ FIXED unzip (never fails)
    - name: Unzip project (safe)
      run: |
        rm -rf cordova_project
        mkdir cordova_project
        unzip -oq FunTarget_Final_Clean.zip -d cordova_project || true
        ls cordova_project

    # ðŸ”¥ FIXED move (auto-detect Cordova folder)
    - name: Prepare Cordova project
      run: |
        cd cordova_project
        PROJECT_DIR=$(find . -maxdepth 2 -name config.xml | head -n 1 | xargs dirname)
        echo "Detected Cordova project at: $PROJECT_DIR"
        mv "$PROJECT_DIR" project
        ls project

    - name: Install project dependencies
      run: |
        cd cordova_project/project
        npm install

    - name: Add Android platform (safe)
      run: |
        cd cordova_project/project
        if [ ! -d "platforms/android" ]; then
          cordova platform add android
        else
          echo "Android platform already exists, skipping."
        fi

    # ðŸ›¡ï¸ à¤¨à¤¯à¤¾ à¤¸à¥à¤°à¤•à¥à¤·à¤¾ à¤¸à¥à¤Ÿà¥‡à¤ª: à¤¯à¤¹ à¤…à¤ªà¤¨à¥‡ à¤†à¤ª MainActivity à¤¢à¥‚à¤à¤¢à¥‡à¤—à¤¾ à¤”à¤° à¤•à¥à¤°à¥ˆà¤¶ à¤•à¥‹à¤¡ à¤¡à¤¾à¤²à¥‡à¤—à¤¾
    - name: Inject Anti-Tamper Security (Auto-detect Package)
      run: |
        cd cordova_project/project
        # 1. MainActivity.java à¤•à¥€ à¤²à¥‹à¤•à¥‡à¤¶à¤¨ à¤¢à¥‚à¤à¤¢à¤¨à¤¾
        MAIN_ACTIVITY_PATH=$(find platforms/android/app/src/main/java -name "MainActivity.java")
        echo "Found MainActivity at: $MAIN_ACTIVITY_PATH"

        # 2. à¤«à¤¾à¤‡à¤² à¤•à¥‡ à¤…à¤‚à¤¦à¤° à¤ªà¥ˆà¤•à¥‡à¤œ à¤¨à¤¾à¤® à¤•à¥‹ à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤°à¤–à¤¨à¤¾ à¤”à¤° à¤¸à¥à¤°à¤•à¥à¤·à¤¾ à¤•à¥‹à¤¡ à¤‡à¤¨à¥à¤œà¥‡à¤•à¥à¤Ÿ à¤•à¤°à¤¨à¤¾
        # à¤¹à¤® à¤¯à¤¹à¤¾à¤ à¤à¤• Bash à¤¸à¥à¤•à¥à¤°à¤¿à¤ªà¥à¤Ÿ à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤° à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚ à¤œà¥‹ à¤«à¤¾à¤‡à¤² à¤•à¥‹ à¤à¤¡à¤¿à¤Ÿ à¤•à¤° à¤¦à¥‡à¤—à¥€
        sed -i '/import org.apache.cordova.\*;/a import android.content.pm.PackageInfo;\nimport android.content.pm.PackageManager;\nimport android.content.pm.Signature;\nimport java.security.MessageDigest;' "$MAIN_ACTIVITY_PATH"
        
        # à¤¯à¤¹ à¤¹à¤¿à¤¸à¥à¤¸à¤¾ onCreate à¤•à¥‡ à¤…à¤‚à¤¦à¤° à¤šà¥‡à¤•à¤¿à¤‚à¤— à¤•à¥‹à¤¡ à¤¡à¤¾à¤²à¥‡à¤—à¤¾
        sed -i '/super.onCreate(savedInstanceState);/a \        if (!verifySignature()) { finish(); System.exit(0); return; }' "$MAIN_ACTIVITY_PATH"

        # à¤¯à¤¹ à¤«à¤¾à¤‡à¤² à¤•à¥‡ à¤…à¤‚à¤¤ à¤®à¥‡à¤‚ verifySignature à¤®à¥‡à¤¥à¤¡ à¤œà¥‹à¥œ à¤¦à¥‡à¤—à¤¾
        sed -i '$d' "$MAIN_ACTIVITY_PATH" # à¤†à¤–à¤¿à¤°à¥€ à¤²à¤¾à¤‡à¤¨ à¤¹à¤Ÿà¤¾à¤“ (})
        cat >> "$MAIN_ACTIVITY_PATH" <<EOF
    private boolean verifySignature() {
        try {
            PackageInfo packageInfo = getPackageManager().getPackageInfo(getPackageName(), PackageManager.GET_SIGNATURES);
            for (Signature signature : packageInfo.signatures) {
                MessageDigest md = MessageDigest.getInstance("SHA-256");
                md.update(signature.toByteArray());
                byte[] digest = md.digest();
                StringBuilder hexString = new StringBuilder();
                for (byte b : digest) { String hex = Integer.toHexString(0xff & b); if (hex.length() == 1) hexString.append('0'); hexString.append(hex); }
                // à¤¯à¤¹à¤¾à¤ à¤…à¤ªà¤¨à¤¾ à¤…à¤¸à¤²à¥€ SHA-256 à¤¡à¤¾à¤²à¥‡à¤‚
                if (hexString.toString().equalsIgnoreCase("${{ secrets.MY_SHA256 }}")) return true;
            }
        } catch (Exception e) {}
        return false;
    }
}
EOF

    # --- 'Full Signing' à¤¹à¤¿à¤¸à¥à¤¸à¤¾ ---

    - name: Decode Keystore
      run: |
        cd cordova_project/project
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > my-release-key.jks

    - name: Create build.json for Full Signing
      run: |
        cd cordova_project/project
        echo '{
          "android": {
            "release": {
              "keystore": "my-release-key.jks",
              "storePassword": "${{ secrets.KEYSTORE_PASSWORD }}",
              "alias": "my-key-alias",
              "password": "${{ secrets.KEYSTORE_PASSWORD }}",
              "keystoreType": ""
            }
          }
        }' > build.json

    - name: Build APK (Signed Release)
      run: |
        cd cordova_project/project
        cordova build android --release --buildConfig=build.json --verbose

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FunTarget-Final-Build
        path: |
          cordova_project/project/platforms/android/app/build/outputs/apk/release/*.apk
          cordova_project/project/platforms/android/app/build/outputs/bundle/release/*.aab
