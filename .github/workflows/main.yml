name: Build Cordova APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install Cordova
      run: npm install -g cordova

    - name: Unzip project
      run: |
        rm -rf cordova_project
        mkdir cordova_project
        unzip -oq FunTarget_Final_Clean.zip -d cordova_project || true

    - name: Prepare Cordova project
      run: |
        cd cordova_project
        PROJECT_DIR=$(find . -maxdepth 2 -name config.xml | head -n 1 | xargs dirname)
        mv "$PROJECT_DIR" project

    - name: Install project dependencies
      run: |
        cd cordova_project/project
        npm install

    - name: Add Android platform
      run: |
        cd cordova_project/project
        cordova platform add android || echo "Platform exists"

    - name: Inject Anti-Tamper Security
      run: |
        cd cordova_project/project
        mkdir -p platforms/android/app/src/main/java/com/funtarget/app/
        FILE_PATH="platforms/android/app/src/main/java/com/funtarget/app/MainActivity.java"

        cat > "$FILE_PATH" <<EOF
        package com.funtarget.app;
        import android.os.Bundle;
        import android.content.pm.PackageInfo;
        import android.content.pm.PackageManager;
        import android.content.pm.Signature;
        import java.security.MessageDigest;
        import org.apache.cordova.*;

        public class MainActivity extends CordovaActivity {
            @Override
            public void onCreate(Bundle savedInstanceState) {
                super.onCreate(savedInstanceState);
                if (!checkSignature()) {
                    finish();
                    System.exit(0);
                    return;
                }
                loadUrl(launchUrl);
            }

            private boolean checkSignature() {
                try {
                    String validSig = "${{ secrets.MY_SHA256 }}".replace(":", "").toUpperCase();
                    if (validSig.isEmpty()) return true;
                    PackageInfo packageInfo = getPackageManager().getPackageInfo(getPackageName(), PackageManager.GET_SIGNATURES);
                    for (Signature signature : packageInfo.signatures) {
                        MessageDigest md = MessageDigest.getInstance("SHA-256");
                        md.update(signature.toByteArray());
                        byte[] digest = md.digest();
                        StringBuilder hexString = new StringBuilder();
                        for (byte b : digest) {
                            String hex = Integer.toHexString(0xff & b);
                            if (hex.length() == 1) hexString.append('0');
                            hexString.append(hex);
                        }
                        if (hexString.toString().equalsIgnoreCase(validSig)) return true;
                    }
                } catch (Exception e) {}
                return false;
            }
        }
        EOF

    - name: Decode Keystore
      run: |
        cd cordova_project/project
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > my-release-key.jks

    - name: Create build.json
      run: |
        cd cordova_project/project
        echo '{
          "android": {
            "release": {
              "keystore": "my-release-key.jks",
              "storePassword": "${{ secrets.KEYSTORE_PASSWORD }}",
              "alias": "my-key-alias",
              "password": "${{ secrets.KEYSTORE_PASSWORD }}",
              "keystoreType": "apk"
            }
          }
        }' > build.json

    - name: Build APK (Release)
      run: |
        cd cordova_project/project
        # --device рдФрд░ buildConfig рдХрд╛ рдЗрд╕реНрддреЗрдорд╛рд▓ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рд╕рд╣реА APK рдмрдиреЗ
        cordova build android --release --device --buildConfig=build.json --verbose

    # ЁЯЪА рд╕реБрдзрд╛рд░рд╛ рд╣реБрдЖ рдЕрдкрд▓реЛрдб рд╕реНрдЯреЗрдк: рдпрд╣ рдкреВрд░реА рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдЪреЗрдХ рдХрд░реЗрдЧрд╛
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FunTarget-Pro-Final-APK
        path: |
          cordova_project/project/platforms/android/app/build/outputs/apk/release/*.apk
          cordova_project/project/platforms/android/app/build/outputs/bundle/release/*.aab
        if-no-files-found: error
